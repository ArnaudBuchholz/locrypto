<html>
  <head>
    <title>LoCrypto</title>
    <style>
input {
  width: 30%;
}

span {
  color: gray;
}

textarea {
  width: 100%;
  margin-top: .5rem;
}

.encrypting {
  background-color: darkgrey;
}
    </style>
  </head>
  <body>
    <input id="key" type="password" placeholder="Type &#128273; or drag & drop a &#128273; file...">
    <button id="encrypt">&#128272;</button>
    <span>&#11013; click to encrypt</span>
    <br/>
    <textarea id="message" rows="20" placeholder="Type the message to encrypt or drag & drop the file to decrypt"></textarea>
    <script language="javascript">
window.addEventListener('load', () => {
  if (window?.crypto?.subtle === undefined) {
    alert('Cryptographic helper not detected')
    location = 'https://developer.mozilla.org/en-US/docs/Web/API/Crypto/subtle'
  }
})
      
function onDrop (callback, event) {
  event.preventDefault()
  if (event.dataTransfer.types.includes('Files')) {
    const file = event.dataTransfer.files[0]
    const reader = new FileReader()
    reader.onload = () => {
      callback(file, reader.result)
    }
    reader.readAsArrayBuffer(file)
  }
}

const byId = id => document.getElementById(id)

const keyInput = byId('key')
let keyBuffer

keyInput.addEventListener('drop', onDrop.bind(null, (file, buffer) => {
  keyBuffer = buffer
  keyInput.setAttribute('type', 'text')
  keyInput.setAttribute('readonly', 'true')
  keyInput.value = `\ud83d\udcbe ${file.name} ${buffer.byteLength}`
}))

function toBuffer (text) {
  const encoder = new TextEncoder()
  return encoder.encode(text)
}

const message = byId('message')
let filename = 'secret.dat'

async function encrypt () {
  message.setAttribute('class', 'encrypting')
  if (!keyBuffer) {
    keyBuffer = toBuffer(keyInput.value)
  }
  let finalKey
  let keyAddendum
  if (keyBuffer.byteLength < 32) {
    keyAddendum = window.crypto.getRandomValues(new Uint8Array(32 - keyBuffer.byteLength))
    finalKey = new Uint8Array(32)
    finalKey.set(keyBuffer)
    finalKey.set(keyAddendum, keyBuffer.byteLength)
  } else {
    finalKey = keyBuffer.slice(0, 32)
  }
  const key = await crypto.subtle.importKey(
    'raw',
    finalKey,
    "AES-CTR",
    false,
    ['encrypt']
  )
  const messageBuffer = toBuffer(message.value)
  let counter = window.crypto.getRandomValues(new Uint8Array(16))
  const cryptedBuffer = await window.crypto.subtle.encrypt(
    {
      name: "AES-CTR",
      counter,
      length: 64
    },
    key,
    messageBuffer
  )
  const blobParts = [counter, cryptedBuffer]
  if (keyAddendum) {
    blobParts.unshift(keyAddendum)
  }
  const blob = new Blob(blobParts)
  const blobUrl = URL.createObjectURL(blob)
  const anchor = document.createElement('a')
  anchor.href = blobUrl
  anchor.target = '_blank'
  anchor.download = filename
  anchor.click()
  URL.revokeObjectURL(blobUrl)
  message.removeAttribute('class')
}

byId('encrypt').addEventListener('click', encrypt)

let isControlPressed = false
document.addEventListener('keyup', event => {
  if (event.keyCode === 17) {
    isControlPressed = false
  }
})

document.addEventListener('keydown', event => {
  if (event.keyCode === 17) {
    isControlPressed = true
  }
  if (event.keyCode === 83 && isControlPressed) {
    event.preventDefault()
    encrypt()
  }
})

message.addEventListener('drop', onDrop.bind(null, async (file, buffer) => {
  filename = file.name
  if (!keyBuffer) {
    keyBuffer = toBuffer(keyInput.value)
  }
  let offset = 0
  let finalKey
  if (keyBuffer.byteLength < 32) {
    offset = 32 - keyBuffer.byteLength
    finalKey = new Uint8Array(32)
    finalKey.set(keyBuffer)
    finalKey.set(new Uint8Array(buffer.slice(0, offset)), keyBuffer.byteLength)
  } else {
    finalKey = keyBuffer.slice(0, 32)
  }
  const key = await crypto.subtle.importKey(
    'raw',
    finalKey,
    "AES-CTR",
    false,
    ['decrypt']
  )
  const counter = buffer.slice(offset, offset + 16)
  offset += 16
  const decryptedBuffer = await window.crypto.subtle.decrypt(
    {
      name: "AES-CTR",
      counter,
      length: 64
    },
    key,
    buffer.slice(offset)
  )
  message.value = new TextDecoder().decode(decryptedBuffer)
}))

      </script>
  </body>
</html>